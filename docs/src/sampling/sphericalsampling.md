# [Spherical Field Samplings](@id sphericalsampling)

If the antenna field is sampled on a (concentric) spherical surface, the situation is best described with a [`SphericalFieldSampling`](@ref). It allows to sample the antenna field at relatively regularly distributed sampling points on a spherical surface. The sampling points on the sphere are defined by a [`SphereSamplingStrategy`](@ref sphericalsamplingstrategy). For each sampling point, the antenna field is sampled with two polarizations, i.e., the probe antenna samples the field in the ``\chi=0`` and the ``\chi=90^°`` configuration.

In general, `SphericalFieldSampling`s can be used with arbitrary probes but the most efficient algorithms arise from so-called first-order probes.

!!! note
    Very efficient algorithms - e.g., for the [transmission](@ref transmission) - arise when a [`SphericalFieldSampling`](@ref) is paired with a 
    [`SphericalWaveExpansion`](@ref).
---

## Constructors of `SphericalFieldSampling`
To construct a `SphericalFieldSampling`, the user can specify
- a `SphereSamplingStrategy` to define the number and location of the sampling points on the sphere
- the spherical coefficients ``\alpha_{s\ell m}^{(1)}`` characterizing the field incident on the antenna under test generated by a radiating probe antenna at the measurement starting position ``\vartheta =0, \varphi = 0, \chi =0``.

This is accomplished by using the constructor
```julia
SphericalFieldSampling(
    samplingstrategy::SphereSamplingStrategy,
    incidentcoefficients::AbstractSphericalCoefficients,
) 
```
Alternatively, the user can specify
- a `SphereSamplingStrategy` to define the number and location of the sampling points on the sphere
- the location and orientation of the probe antenna at the measurement starting position ``\vartheta =0, \varphi = 0, \chi =0``
- a [`ProbeAntenna`](@ref) object characerizing the utilized probe antenna
- (a flag to indicate if the probe should be treated as a first-order probe)

This is accomplished by using the constructor
```julia
SphericalFieldSampling(
    samplingstrategy::SphereSamplingStrategy,
    initialposition::AbstractVector,
    eulerangles::Tuple{<:Real, <:Real, <:Real},
    probe::ProbeAntenna;
    firstorder::Bool=false
) 
```

Using the latter constructor, the incident probe field coefficients are calculatated for the probe configuration and fed into the former constructor to generate the `SphereSamplingStrategy`.

## [Spherical Sampling Strategies](@id sphericalsamplingstrategy)

At the moment, `AntennaFieldRepresentations.jl` supports two different kinds of `SpheresamplingStrategy`s: 
- [`RegularθRegularϕSampling`](@ref)
- [`GaussLegendreθRegularϕSampling`](@ref)

### [`RegularθRegularϕSampling`](@id regularspheresamplingstrategy)
A `RegularθRegularϕSampling` has  ``N_\varphi`` equally distributed samples samples along ``\varphi`` with  ``0\leq \varphi < 2\pi`` and ``N_\vartheta`` equally distributed samples along ``vartheta`` with  ``0\leq \varphi \leq 2\pi``.

The sampling steps ``\Delta\vartheta = 2\pi / J_\vartheta`` and ``\Delta\varphi = 2\pi / J_\varphi`` are whole-number fractions of ``2\pi`` to guarantee that the sampling step between the two samples at the end of a ``\varphi``-ring or a ``\vartheta``
ring is the same as everywhere else.
This is enforced during the construction of a `RegularθRegularϕSampling` as the whole-number divisors ``J_\vartheta`` and ``J_\varphi`` are the input arguments for the constructor.

To generate a `RegularθRegularϕSampling` struct, use the following constructor
```julia
RegularθRegularϕSampling(Jθ::Integer, Jϕ::Integer)
```

!!! note
    A `RegularθRegularϕSampling` always contains ``N_\varphi`` samples at the North Pole.    
---

### [`GaussLegendreθRegularϕSampling`](@id gausslegendresamplingstrategy)
A `GaussLegendreθRegularϕSampling` is sampled along ``\varphi`` with ``N_\varphi`` equally distributed samples  in ``0\leq \varphi < 2\pi`` and ``N_\vartheta`` ``\vartheta``-samples on a Gauß-Legendre based grid with ``0< \vartheta < \pi``, according to 
```math
\vartheta_k=\text{arccos}(-x_k)
```
where ``x_k`` are the roots of the ``N_\vartheta``th Legendre polynomial. 

To generate a `GaussLegendreθRegularϕSampling` struct, use the following constructor
```julia
GaussLegendreθRegularϕSampling(Nθ::Integer, Nϕ::Integer)
```
where `Nθ` corresponds to the stored number of samples in ``\vartheta``-direction and `Nϕ` corresponds to the number of samples in ``\varphi``
direction.

The figures below compare the regular sampling points in a `RegularθRegularϕSampling` and the Lagrange sampling points utilized by a `GaussLegendreθRegularϕSampling`. 


```@raw html
<figure>
<picture>
  <source  srcset="../assets/sampling_regular.svg" width="200">
  <img alt="" src="" width="200">
</picture>

  <figcaption>
    This is a regularly sampled sphere.
  </figcaption>
</figure>
<br/>
```
```@raw html
<figure>
<picture>
  <source  srcset="../assets/sampling_lagrange.svg" width="200">
  <img alt="" src="" width="200">
</picture>

  <figcaption>
    This sphere is sampled according to a Gauß-Legendre sampling rule.
  </figcaption>
</figure>
<br/>
```


## Spherical Coefficients of the Incident Probe Field
The incident probe field coefficients are represented by a vector of [`AbstractSphericalCoefficients`](@ref abstractsphericalcoeficients) type. The user must identify the spherical coefficients of the incident probe field (relative to an AUT-centered coordinate system) in a pre-processing step.

The vector for the incident field coefficients must be of type [`SphericalCoefficients`](@ref) if it contains non-zero entries for some coefficients with ``m \neq \pm 1`` or of type [`FirstOrderSphericalCoefficients`](@ref) if all coefficients with ``m \neq \pm 1`` can be ignored.

To create a vector of type [`AbstractSphericalCoefficients`](@ref), use one of the following constructors:
```julia
SphericalCoefficients(x::AbstractVector)
```
```julia
FirstOrderSphericalCoefficients(x::AbstractVector)
```

!!! note
    Since a vector of type `SphericalCoefficients` is itself a subtype of `AbstractVector`, we can easily convert a vector of `SphericalCoefficients` into a vector of first-order spherical coefficients via 
    ```julia 
    FirstorderSphericalCoefficients(x::SphericalCoefficients)
    ``` 

    Converting a an arbitrary `AbstractVector` into a `FirstOrderSphericalCoefficients`-vector drops all entries which correspond to non-first-order modes.    
---

## [Far Field Sampling](@id farfieldsampling)
The far-field of the antenna under test is equivalently calculated as the received signal by the AuT when illuminated by an incident plane wave. The spherical coefficients of an incident plane wave [are analytically known](@ref farfieldcoefficients). They can be conveniently collected up to mode order ``L`` via the method 
```julia 
αinc_planewave(L::Integer)
```
returning a vector of type [`FirstOrderSphericalCoefficients`](@ref) because all coefficients with ``m \neq \pm 1`` are zero for the incident plane wave.